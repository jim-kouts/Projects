# ci.yml
# =======
# GitHub Actions CI pipeline for the OCR project inside the Projects repo.
# Runs automatically on every push or pull request to main branch.
#
# Since the OCR project lives inside a subfolder of the Projects repo,
# all paths point to: "Optical Character Recognition (OCR)/"
#
# Jobs:
#   1. lint    — check code style with flake8
#   2. test    — run unit tests with pytest
#   3. docker  — verify Docker image builds correctly

name: OCR Project CI Pipeline

# Trigger: only run when files inside the OCR project folder change
on:
  push:
    branches: [ main ]
    paths:
      - "Optical Character Recognition (OCR)/**"
  pull_request:
    branches: [ main ]
    paths:
      - "Optical Character Recognition (OCR)/**"

jobs:

  # ── Job 1: Linting ───────────────────────────────────────────
  lint:
    name: Code Quality Check (flake8)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8 on OCR project
        # Ignored rules:
        # E501  = line too long (ML code has long lines)
        # W503  = line break before binary operator
        # E221  = multiple spaces before operator (we use alignment spacing)
        # E241  = multiple spaces after ':' (we use alignment spacing)
        # E402  = module level import not at top (we use sys.path.append first)
        # F401  = imported but unused (some imports used only at runtime)
        # W292  = no newline at end of file
        # F541  = f-string without placeholders
        run: |
          flake8 \
            "Optical Character Recognition (OCR)/src/" \
            "Optical Character Recognition (OCR)/api/" \
            "Optical Character Recognition (OCR)/utils/" \
            --max-line-length=120 \
            --ignore=E501,W503,E221,E241,E402,F401,W292,F541 \
            --count \
            --statistics

  # ── Job 2: Unit Tests ────────────────────────────────────────
  test:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install lightweight test dependencies
        # Only install what the tests actually need
        # We do NOT install torch/transformers — too heavy for CI
        # The tests are written to avoid importing those modules
        run: pip install pytest numpy

      - name: Run unit tests
        env:
          PYTHONPATH: "Optical Character Recognition (OCR)"
        run: |
          pytest "Optical Character Recognition (OCR)/tests/" -v

  # ── Job 3: Docker Build ──────────────────────────────────────
  docker:
    name: Docker Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        # Build from inside the OCR project folder
        # The Dockerfile uses relative paths (COPY src/ etc.)
        run: |
          docker build \
            -t ocr-invoice-app \
            "Optical Character Recognition (OCR)/"